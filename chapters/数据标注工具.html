<!DOCTYPE HTML>
<html lang="zh-hans">
<head>
<meta charset="utf-8"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>数据标注工具.md · 深度学习相关学习记录</title>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="" name="description"/>
<meta content="GitBook 3.2.3" name="generator"/>
<meta content="narutohyc" name="author"/>
<link href="../gitbook/style.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-splitter/splitter.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-anchors/plugin.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-donate/plugin.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-code/plugin.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-search-plus/search.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-lightbox/css/lightbox.min.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-pageview-count/plugin.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-highlight/website.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-fontsettings/website.css" rel="stylesheet"/>
<link href="../gitbook/gitbook-plugin-theme-comscore/test.css" rel="stylesheet"/>
<meta content="true" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
<link href="../gitbook/images/apple-touch-icon-precomposed-152.png" rel="apple-touch-icon-precomposed" sizes="152x152"/>
<link href="../gitbook/images/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="深度学习核心之优化器.html" rel="next"/>
<link href="图神经网络.html" rel="prev"/>
<link href="./chapters/res/other/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="./chapters/res/other/favicon.ico" rel="apple-touch-icon-precomposed" sizes="152x152"/>
<style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
<script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"hycBook","repo":"bk_dl_page","type":"star","size":"small","count":true}]};
    </script>
</head>
<body>
          <div class="mountain_a"></div>
          <div class="mountain_b"></div>
          <div class="house right">
            <div class="fence"></div>
            <div class="wall"></div>
            <div class="roof left"></div>
            <div class="roof right"></div>
            <div class="door"></div>
          </div>
          <div class="house left">
            <div class="fence"></div>
            <div class="wall"></div>
            <div class="roof left"></div>
            <div class="roof right"></div>
            <div class="door"></div>
          </div>
          <div class="tree_back"></div>
          <div class="tree"></div>
          <div class="postbox_a">
            <div class="hole"></div>
          </div>
          <div class="postbox_b">
            <div class="hole"></div>
          </div>
          <div class="windmill">
            <div class="tower"></div>
            <div class="t1"></div>
            <div class="t2"></div>
            <div class="blade">
              <div class="windblade"></div>
              <div class="windblade windblade2"></div>
              <div class="windblade windblade3"></div>
              <div class="windblade windblade4"></div>
            </div>
          </div>
          <div class="allsnows">
            <div class="snow1"></div>
            <div class="snow2"></div>
            <div class="snow3"></div>
            <div class="snow4"></div>
            <div class="snow5"></div>
            <div class="snow6"></div>
            <div class="snow7"></div>
            <div class="snow8"></div>
            <div class="snow9"></div>
            <div class="snow10"></div>
            <div class="snow11"></div>
            <div class="snow12"></div>
            <div class="snow13"></div>
            <div class="snow14"></div>
            <div class="snow15"></div>
            <div class="snow16"></div>
            <div class="snow17"></div>
            <div class="snow18"></div>
            <div class="snow19"></div>
            <div class="snow20"></div>
          </div>
          <div class="ground">
            <div class="g1"></div>
            <div class="g2"></div>
            <div class="g3"></div>
            <div class="ice">
              <div class="glare"></div>
              <div class="ice_shadow"></div>
            </div>

          </div>
    
<div class="book">
<div class="book-summary">
<div id="book-search-input" role="search">
<input placeholder="输入并搜索" type="text"/>
</div>
<nav role="navigation">
<ul class="summary">
<li>
<a class="custom-link" href="https://study.hycbook.com" target="_blank">书籍主页</a>
</li>
<li class="divider"></li>
<li class="chapter" data-level="1.1" data-path="../" id="chapter_id_0">
<a href="../">
<b>1.1.</b>
                    
                    Introduction
            
                </a>
</li>
<li class="chapter" data-level="1.2" data-path="LLM Tokenizer分词系列.html" id="chapter_id_1">
<a href="LLM Tokenizer分词系列.html">
<b>1.2.</b>
                    
                    LLM Tokenizer分词系列.md
            
                </a>
</li>
<li class="chapter" data-level="1.3" data-path="LLM模型微调系列.html" id="chapter_id_2">
<a href="LLM模型微调系列.html">
<b>1.3.</b>
                    
                    LLM模型微调系列.md
            
                </a>
</li>
<li class="chapter" data-level="1.4" data-path="LLM模型部署调试推理.html" id="chapter_id_3">
<a href="LLM模型部署调试推理.html">
<b>1.4.</b>
                    
                    LLM模型部署调试推理.md
            
                </a>
</li>
<li class="chapter" data-level="1.5" data-path="dl_in_vision_field.html" id="chapter_id_4">
<a href="dl_in_vision_field.html">
<b>1.5.</b>
                    
                    dl_in_vision_field.md
            
                </a>
</li>
<li class="chapter" data-level="1.6" data-path="huggingface基本使用教程.html" id="chapter_id_5">
<a href="huggingface基本使用教程.html">
<b>1.6.</b>
                    
                    huggingface基本使用教程.md
            
                </a>
</li>
<li class="chapter" data-level="1.7" data-path="nlp关键词和摘要提取技术整理.html" id="chapter_id_6">
<a href="nlp关键词和摘要提取技术整理.html">
<b>1.7.</b>
                    
                    nlp关键词和摘要提取技术整理.md
            
                </a>
</li>
<li class="chapter" data-level="1.8" data-path="pytorch学习.html" id="chapter_id_7">
<a href="pytorch学习.html">
<b>1.8.</b>
                    
                    pytorch学习.md
            
                </a>
</li>
<li class="chapter" data-level="1.9" data-path="transformer.html" id="chapter_id_8">
<a href="transformer.html">
<b>1.9.</b>
                    
                    transformer.md
            
                </a>
</li>
<li class="chapter" data-level="1.10" data-path="图像分割算法.html" id="chapter_id_9">
<a href="图像分割算法.html">
<b>1.10.</b>
                    
                    图像分割算法.md
            
                </a>
</li>
<li class="chapter" data-level="1.11" data-path="图像分类算法.html" id="chapter_id_10">
<a href="图像分类算法.html">
<b>1.11.</b>
                    
                    图像分类算法.md
            
                </a>
</li>
<li class="chapter" data-level="1.12" data-path="图神经网络.html" id="chapter_id_11">
<a href="图神经网络.html">
<b>1.12.</b>
                    
                    图神经网络.md
            
                </a>
</li>
<li class="chapter active" data-level="1.13" data-path="数据标注工具.html" id="chapter_id_12">
<a href="数据标注工具.html">
<b>1.13.</b>
                    
                    数据标注工具.md
            
                </a>
</li>
<li class="chapter" data-level="1.14" data-path="深度学习核心之优化器.html" id="chapter_id_13">
<a href="深度学习核心之优化器.html">
<b>1.14.</b>
                    
                    深度学习核心之优化器.md
            
                </a>
</li>
<li class="chapter" data-level="1.15" data-path="深度学习核心之损失函数.html" id="chapter_id_14">
<a href="深度学习核心之损失函数.html">
<b>1.15.</b>
                    
                    深度学习核心之损失函数.md
            
                </a>
</li>
<li class="chapter" data-level="1.16" data-path="深度学习核心之激活函数.html" id="chapter_id_15">
<a href="深度学习核心之激活函数.html">
<b>1.16.</b>
                    
                    深度学习核心之激活函数.md
            
                </a>
</li>
<li class="chapter" data-level="1.17" data-path="深度学习核心基础知识点.html" id="chapter_id_16">
<a href="深度学习核心基础知识点.html">
<b>1.17.</b>
                    
                    深度学习核心基础知识点.md
            
                </a>
</li>
<li class="chapter" data-level="1.18" data-path="深度学习模型压缩技术.html" id="chapter_id_17">
<a href="深度学习模型压缩技术.html">
<b>1.18.</b>
                    
                    深度学习模型压缩技术.md
            
                </a>
</li>
<li class="chapter" data-level="1.19" data-path="目标检测与跟踪算法.html" id="chapter_id_18">
<a href="目标检测与跟踪算法.html">
<b>1.19.</b>
                    
                    目标检测与跟踪算法.md
            
                </a>
</li>
<li class="divider"></li>
<li>
<a class="gitbook-link" href="https://www.gitbook.com" target="blank">
            本书使用 GitBook 发布
        </a>
</li>
</ul>
</nav>
</div>
<div class="book-body">
<div class="body-inner">
<div class="book-header" role="navigation">
<!-- Title -->
<h1>
<i class="fa fa-circle-o-notch fa-spin"></i>
<a href="..">数据标注工具.md</a>
</h1>
</div>
<div class="page-wrapper" role="main" tabindex="-1">
<div class="page-inner">
<div class="search-plus" id="book-search-results">
<div class="search-noresults">
<section class="normal markdown-section">
<div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon"></span><a href="#label-studio">1 label-studio</a></li><ul><li><span class="title-icon"></span><a href="#前端">1.1 前端</a></li><ul><li><span class="title-icon"></span><a href="#安装">1.1.1 安装</a></li><li><span class="title-icon"></span><a href="#数据库配置">1.1.2 数据库配置</a></li><li><span class="title-icon"></span><a href="#导入现有标注">1.1.3 导入现有标注</a></li><li><span class="title-icon"></span><a href="#cloudreve数据导入">1.1.4 Cloudreve数据导入</a></li><li><span class="title-icon"></span><a href="#新建标注项目">1.1.5 新建标注项目</a></li></ul><li><span class="title-icon"></span><a href="#后端">1.2 后端</a></li><ul><li><span class="title-icon"></span><a href="#介绍">1.2.1 介绍</a></li><li><span class="title-icon"></span><a href="#模型创建">1.2.2 模型创建</a></li><li><span class="title-icon"></span><a href="#使用步骤">1.2.3 使用步骤</a></li><li><span class="title-icon"></span><a href="#例子">1.2.4 例子</a></li></ul></ul><li><span class="title-icon"></span><a href="#doccano">2 doccano</a></li><li><span class="title-icon"></span><a href="#roboflow">3 Roboflow</a></li></ul></div><a href="#label-studio" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><hr/>
<h1 id="label-studio">1 label-studio</h1>
<blockquote>
<p><a href="https://labelstud.io/guide/get_started.html#Features" target="_blank">label-studio社区版和企业版比较</a></p>
<p><a href="https://openbayes.com/docs/tutorials/use-label-studio-ml-backend-with-uie/#训练模型" target="_blank"> 基于UIE的命名实体识别下的label-studio-ml教程</a></p>
<p><a href="https://labelstud.io/guide/predictions.html#Specific-examples-for-pre-annotations" target="_blank">Specific-examples-for-pre-annotations</a></p>
</blockquote>
<p><code>Label Studio</code>是一个开源的，可配置的数据注释工具，其目的是使您能够使用标准化输出格式的最方便的界面标记不同类型的数据</p>
<p><strong>特色</strong>：支持多人协作，支持主动学习、支持多种的标注的任务</p>
<p><strong>缺点</strong>：在目标检测标注时，好像没有十字辅助线</p>
<p>支持的标注任务，包括了如下所示，具体的见官方git介绍</p>
<p><a data-lightbox="68ae6099-e896-4e44-b727-69aeab30200d" data-title="支持的标注任务" href="https://pic.hycbook.com/i/hexo/bk_resources/deep_learning/数据标注工具/支持的标注任务.webp" target="_blank"><img alt="支持的标注任务" src="https://pic.hycbook.com/i/hexo/bk_resources/deep_learning/数据标注工具/支持的标注任务.webp"/></a></p>
<blockquote>
<p><a href="https://www.cnblogs.com/ifantasy/p/16930932.html" target="_blank">label studio 结合 MMDetection 实现数据集自动标记、模型迭代训练的闭环</a></p>
<p><a href="https://zeronewlife.xyz/archives/labelstudio-shi-yong-ji-qiao#label-studio" target="_blank">Label Studio使用技巧</a></p>
</blockquote>
<p>关键的两个git仓库，其中label-studio的官方文档在<a href="https://labelstud.io/guide/get_started.html" target="_blank">这里</a></p>
<ol>
<li><a href="https://github.com/heartexlabs/label-studio" target="_blank">label-studio</a>， 进行普通的图片标记工作，如果要使用其提供的辅助预标记功能，则需要进行后续配置</li>
<li><a href="https://github.com/heartexlabs/label-studio-ml-backend" target="_blank">label-studio-ml-backend</a>，主要提供深度学习服务，包括<code>预标记</code>和<code>模型训练</code>，结合前端形成模型迭代训练的<code>主动学习</code>效果</li>
</ol>
<blockquote>
<p>版本</p>
</blockquote>
<pre><code class="lang-cmd">-- 前端
<span class="hljs-built_in">label</span>-studio==<span class="hljs-number">1</span>.<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.post0

-- 后端
<span class="hljs-built_in">label</span>-studio-ml==<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">9</span>
gunicorn==<span class="hljs-number">20</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>
rq==<span class="hljs-number">1</span>.<span class="hljs-number">10</span>.<span class="hljs-number">1</span>

-- 下面这两个自己会安装
<span class="hljs-built_in">label</span>-studio-converter==<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">57</span>
<span class="hljs-built_in">label</span>-studio-tools==<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">3</span>
</code></pre>
<p>前后端结合可以达到模型自动标记数据集、数据集更新迭代训练模型的<strong>闭环</strong></p>
<h2 id="前端">1.1 前端</h2>
<h3 id="安装">1.1.1 安装</h3>
<pre><code class="lang-cmd">pip install <span class="hljs-built_in">label</span>-studio
# 如果安装psycopg2==<span class="hljs-number">2</span>.<span class="hljs-number">9</span>.<span class="hljs-number">5</span> 失败, 可以先装下下面的库
sudo yum install python-devel postgresql-devel postgresql-libs gcc
</code></pre>
<p>环境安装完成后在任意位置打开命令行，使用以下命令启动 label studio</p>
<pre><code class="lang-cmd"># 不指定路径时, 默认放在了 /root/.local/share/<span class="hljs-built_in">label</span>-studio
<span class="hljs-built_in">label</span>-studio --data-<span class="hljs-built_in">dir</span> <span class="hljs-built_in">Label</span>-Studio -p <span class="hljs-number">80</span>
</code></pre>
<p>其中 <code>--data-dir</code> 用于指定工作目录， <code>-p</code> 用来指定运行端口，运行成功后会当前目录会生成 Label-Studio 目录</p>
<p>浏览器打开label studio工作界面，创建用户后即可登录使用(这里的创建很简单，符合规范就可以)</p>
<p>文件夹中主要包括了export和media文件夹，以及一个label_studio.sqlite3数据库文件</p>
<h3 id="数据库配置">1.1.2 数据库配置</h3>
<p>数据库默认使用的是sqlite3，还可以配置其他的关系库，如<a href="https://labelstud.io/guide/storedata.html" target="_blank">PostgreSQL</a>等，通常如果你想标注数百万个任务，或者预计会有很多并发用户，或者你计划在现实生活中的项目中工作，那么使用PostgreSQL数据库</p>
<p>官方提供的设置pg的环境变量好像不起效果，不知道把数据库建哪里去了，这里直接在命令行带上pg库的参数</p>
<pre><code class="lang-cmd">DJANGO_DB=default POSTGRE_NAME=label_studio_db POSTGRE_USER=postgres POSTGRE_PASSWORD=xxx POSTGRE_PORT=<span class="hljs-number">5432</span> POSTGRE_HOST=<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">123</span>.xx LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/home/huangyc/label_ws <span class="hljs-built_in">label</span>-studio <span class="hljs-built_in">start</span> --data-<span class="hljs-built_in">dir</span> /home/huangyc/label_ws -p <span class="hljs-number">8080</span>
</code></pre>
<p><code>LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT</code>用于<strong>指定本地文件的位置</strong>，项目设置里面配置本地路径为<code>/home/huangyc/label_ws/media</code>(这只是个例子好像配成<code>/home/huangyc/label_ws/media/upload</code>也是一样的)，此时可以访问</p>
<pre><code class="lang-python"># 注意?d后面的路径是LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT配置的路径后面继续开始
http://192.168.123.xx:8080/data/local-files?d=media/upload/3/demo.jpg
</code></pre>
<p>当前目录结构如下</p>
<pre><code class="lang-cmd">(label38) [root@uslave02 label_ws]# <span class="hljs-built_in">tree</span> -d
.
├── export
└── media
    ├── avatars
    ├── export
    └── upload
        ├── <span class="hljs-number">1</span>
        ├── <span class="hljs-number">3</span>
            ├── demo.jpg
        └── <span class="hljs-number">4</span>

<span class="hljs-number">8</span> directories
</code></pre>
<p>注意这里需要提前创建好数据库<code>label_studio_db</code>，启动完成控制台输出如下的日志</p>
<pre><code class="lang-cmd"><span class="hljs-built_in">label</span>-studio <span class="hljs-built_in">start</span> --data-<span class="hljs-built_in">dir</span> /home/huangyc/label_ws -p <span class="hljs-number">8080</span>
=&gt; Database and media directory: /root/.local/share/<span class="hljs-built_in">label</span>-studio
=&gt; Static URL is <span class="hljs-built_in">set</span> to: /static/
=&gt; Database and media directory: /home/huangyc/label_ws
=&gt; Static URL is <span class="hljs-built_in">set</span> to: /static/
Starting new HTTPS connection (<span class="hljs-number">1</span>): pypi.org:<span class="hljs-number">443</span>
<span class="hljs-function">https://<span class="hljs-title">pypi.org</span>:443 "<span class="hljs-title">GET</span> /<span class="hljs-title">pypi</span>/<span class="hljs-title">label</span>-<span class="hljs-title">studio</span>/<span class="hljs-title">json</span> <span class="hljs-title">HTTP</span>/1.1" 200 56156
<span class="hljs-title">Initializing</span> <span class="hljs-title">database</span>..
<span class="hljs-title">Performing</span> <span class="hljs-title">system</span> <span class="hljs-title">checks</span>...

[2023-03-29 05:01:46,560] [<span class="hljs-title">django</span>::<span class="hljs-title">register_actions_from_dir</span>::97] [<span class="hljs-title">INFO</span>] <span class="hljs-title">No</span> <span class="hljs-title">module</span> <span class="hljs-title">named</span> '<span class="hljs-title">data_manager.actions.__pycache_</span>'
[2023-03-29 05:01:46,560] [<span class="hljs-title">django</span>::<span class="hljs-title">register_actions_from_dir</span>::97] [<span class="hljs-title">INFO</span>] <span class="hljs-title">No</span> <span class="hljs-title">module</span> <span class="hljs-title">named</span> '<span class="hljs-title">data_manager.actions.__pycache_</span>'
<span class="hljs-title">System</span> <span class="hljs-title">check</span> <span class="hljs-title">identified</span> <span class="hljs-title">no</span> <span class="hljs-title">issues</span> (1 <span class="hljs-title">silenced</span>).
<span class="hljs-title">March</span> 29, 2023 - 05:01:46
<span class="hljs-title">Django</span> <span class="hljs-title">version</span> 3.2.16, <span class="hljs-title">using</span> <span class="hljs-title">settings</span> '<span class="hljs-title">label_studio.core.settings.label_studio</span>'
<span class="hljs-title">Starting</span> <span class="hljs-title">development</span> <span class="hljs-title">server</span> <span class="hljs-title">at</span> <span class="hljs-title">http</span>://0.0.0.0:8080/
<span class="hljs-title">Quit</span> <span class="hljs-title">the</span> <span class="hljs-title">server</span> <span class="hljs-title">with</span> <span class="hljs-title">CONTROL</span>-<span class="hljs-title">C</span>.
</span></code></pre>
<p>此时数据库<code>label_studio_db</code>里面会建好所有的表，比如<code>htx_user</code>存的就是注册的用户信息</p>
<p>如果要后台执行，可以新建一个start.sh脚本</p>
<pre><code class="lang-cmd">DJANGO_DB=default POSTGRE_NAME=label_studio_db POSTGRE_USER=postgres POSTGRE_PASSWORD=xxx POSTGRE_PORT=<span class="hljs-number">5432</span> POSTGRE_HOST=<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">123</span>.xx <span class="hljs-built_in">label</span>-studio <span class="hljs-built_in">start</span> --data-<span class="hljs-built_in">dir</span> /home/huangyc/label_ws -p <span class="hljs-number">8080</span>
</code></pre>
<p>然后执行<code>nohup sh start.sh &gt; log_start.log &amp;</code></p>
<h3 id="导入现有标注">1.1.3 导入现有标注</h3>
<p>将现有标注转为json格式可以用<a href="https://github.com/heartexlabs/label-studio-converter" target="_blank">label-studio-converter工具</a>，安装命令为<code>pip install label-studio-converter</code></p>
<p><strong>转换的例子</strong>，目录结构为:</p>
<pre><code class="lang-cmd"><span class="hljs-function">Q:.
├─<span class="hljs-title">images</span>
   ├─ 1.<span class="hljs-title">jpg</span>
   ├─ 2.<span class="hljs-title">jpg</span>
└─<span class="hljs-title">labels</span>
   ├─ 1.<span class="hljs-title">txt</span>
   ├─ 2.<span class="hljs-title">txt</span>
├─ <span class="hljs-title">classes.txt</span>   # 注意这里的<span class="hljs-title">classes.txt</span>里面的类别顺序一定要正确，如果是从<span class="hljs-title">label</span>-<span class="hljs-title">studio</span>前端导出的，好像顺序会有问题，可以用<span class="hljs-title">notes.json</span>去获取正确的顺序

# 代码为
<span class="hljs-title">annotation_labels</span> = <span class="hljs-title">json_load_op</span>('<span class="hljs-title">notes.json</span>')['<span class="hljs-title">categories</span>']
<span class="hljs-title">annotation_labels</span> = <span class="hljs-title">sorted</span>(<span class="hljs-title">annotation_labels</span>, <span class="hljs-title">key</span>=<span class="hljs-title">lambda</span> <span class="hljs-title">k</span>: <span class="hljs-title">int</span>(<span class="hljs-title">k</span>['<span class="hljs-title">id</span>']))
<span class="hljs-title">annotation_labels</span> = [<span class="hljs-title">anno</span>['<span class="hljs-title">name</span>'] <span class="hljs-title">for</span> <span class="hljs-title">anno</span> <span class="hljs-title">in</span> <span class="hljs-title">annotation_labels</span>]
</span></code></pre>
<p>命令行为</p>
<pre><code class="lang-cmd"><span class="hljs-built_in">label</span>-studio-converter import yolo -i project-<span class="hljs-number">1</span> -o ls-tasks.json --image-root-url /data/local-files?d=tmp/images
</code></pre>
<p>输出<code>ls-tasks.json</code>和<code>ls-tasks.label_config.xml</code>两个文件，第一个是数据的索引和标签信息，第二个是项目的标签配置文件</p>
<p>此时要把文件上传到<code>LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT/tmp/images</code>下才可以看到</p>
<p>如果这里转换出来的路径不对，可以修改<code>label_studio_converter\imports\yolo.py.py</code>下的</p>
<pre><code class="lang-python">task = {
            <span class="hljs-string">"data"</span>: {
                <span class="hljs-comment"># eg. '../../foo+you.py' -&gt; '../../foo%2Byou.py'</span>
                <span class="hljs-string">"image"</span>: f<span class="hljs-string">"{image_root_url}{sp}{image_file_base}"</span> <span class="hljs-comment"># 改完后的</span>
            },
            <span class="hljs-comment"># 'annotations' or 'predictions'</span>
            out_type: [
                {
                    <span class="hljs-string">"result"</span>: [],
                    <span class="hljs-string">"ground_truth"</span>: <span class="hljs-keyword">False</span>,
                }
            ]
        }
</code></pre>
<p>不然会访问不到数据</p>
<p>如果数据没有标注信息，可以将数据传到<code>LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT/tmp/images</code>下，并生成如下json文件，并在项目界面导入该文件即可</p>
<pre><code class="lang-json">[
    {<span class="hljs-string">"image"</span>:<span class="hljs-string">"/data/local-files?d=tmp/images/175.jpg"</span>},
    {<span class="hljs-string">"image"</span>:<span class="hljs-string">"/data/local-files?d=tmp/images/696.jpg"</span>}
]
</code></pre>
<h3 id="cloudreve数据导入">1.1.4 Cloudreve数据导入</h3>
<blockquote>
<p><a href="https://blog.csdn.net/longzhoufeng/article/details/108958091" target="_blank">cloudreve私有云盘配置后台运行</a></p>
<p>安装配置Cloudreve</p>
</blockquote>
<p><a href="https://docs.cloudreve.org/getting-started/install" target="_blank">Cloudreve</a>可助你即刻构建出兼备自用或公用的网盘服务，通过多种存储策略的支持、虚拟文件系统等特性实现灵活的文件管理体验</p>
<p>Linux 下，直接解压并执行主程序即可：</p>
<pre><code class="lang-cmd">#解压获取到的主程序
tar -zxvf cloudreve_VERSION_OS_ARCH.tar.gz

# 赋予执行权限
chmod +x ./cloudreve

# 启动 Cloudreve
nohup ./cloudreve &gt; <span class="hljs-built_in">start</span>.log &amp;
</code></pre>
<p>Windows下，直接解压获取到的 zip 压缩包，启动 <code>cloudreve.exe</code> 即可</p>
<p>Cloudreve在首次启动时，会创建初始管理员账号，请注意保管管理员密码，此密码只会在首次启动时出现。如果您忘记初始管理员密码，需要删除同级目录下的<code>cloudreve.db</code>，重新启动主程序以初始化新的管理员账户。或者使用<code>./cloudreve --database-script ResetAdminPassword</code>重置密码</p>
<p>Cloudreve默认会监听<code>5212</code>端口。你可以在浏览器中访问<code>http://服务器IP:5212</code>进入 Cloudreve。</p>
<p>以上步骤操作完后，最简单的部署就完成了。你可能需要一些更为具体的配置，才能让 Cloudreve 更好的工作</p>
<p>登录管理员，<strong>编辑存储策略</strong>下的<code>Default storage policy</code>，将存储文件名改为<code>{originname}</code>，不然会默认会带上一些前缀</p>
<p>Cloudreve的文件实际上是存储在<code>/home/huangyc/cloudreve/uploads/1</code>下，在此目录下新建软链接<code>label_ws</code>到label-studio的工作目录下，至此</p>
<pre><code class="lang-cmd">[root@uslave02 <span class="hljs-number">1</span>]# ln -s /home/huangyc/label_ws/uploads label_ws
[root@uslave02 <span class="hljs-number">1</span>]# pwd
/home/huangyc/cloudreve/uploads/<span class="hljs-number">1</span>
</code></pre>
<p>此时，界面网页上可以看到label_ws文件夹，后续的项目文件可以传到这里，至此Cloudreve配置完成</p>
<blockquote>
<p>label-studio项目设置</p>
</blockquote>
<p>这里可以将label-studio项目的云存储位置设置为本地<code>/home/huangyc/label_ws/uploads</code>，然后导入一下json文件到项目</p>
<pre><code class="lang-json">[
    {<span class="hljs-string">"image"</span>:<span class="hljs-string">"/data/local-files?d=uploads/tricycle_samples/灭鬼之刃.png"</span>}
]
</code></pre>
<p>最后通过Cloudreve，把文件<code>灭鬼之刃.png</code>上传到<code>label_ws/tricycle_samples</code>下就可以看到图片了，<strong>注意</strong>：这里的<code>label_ws</code>相当于<code>/home/huangyc/label_ws/uploads</code>，这就是<strong>软链接的魅力</strong></p>
<h3 id="新建标注项目">1.1.5 新建标注项目</h3>
<p>在 label studio 前端主页中选择创建项目，主要流程</p>
<ol>
<li>填写项目基本信息</li>
<li>导入数据</li>
<li>选择标记模板: label studio内置了很多常见的深度学习标记模板</li>
</ol>
<p>以下是目标检测的模板</p>
<pre><code class="lang-python">&lt;View&gt;
  &lt;Image name="image" value="$image" zoom="true" showMousePos="true" zoomControl="true" rotateControl="true"/&gt;
  &lt;View&gt;
    &lt;Filter toName="label" minlength="0" name="filter"/&gt;
    &lt;RectangleLabels name="label" toName="image"&gt;
      &lt;Label value="tricycle" background="#ca9eff" category="0"/&gt;
      &lt;Label value="person" background="#50b01c" category="1"/&gt;
    &lt;/RectangleLabels&gt;
  &lt;/View&gt;
&lt;/View&gt;
</code></pre>
<p><code>category</code>很重要，能保证标签的顺序，这里要从0开始</p>
<p>此时我们已经可以通过 label studio 进行普通的图片标记工作，如果要使用其提供的辅助预标记功能，则需要进行后续配置</p>
<p><a data-lightbox="89ed29b3-2ab9-474d-b6d8-fb8b308cac95" data-title="labelstudio-ui" href="https://pic.hycbook.com/i/hexo/bk_resources/deep_learning/数据标注工具/labelstudio-ui.gif" target="_blank"><img alt="labelstudio-ui" src="https://pic.hycbook.com/i/hexo/bk_resources/deep_learning/数据标注工具/labelstudio-ui.gif"/></a></p>
<h2 id="后端">1.2 后端</h2>
<h3 id="介绍">1.2.1 介绍</h3>
<p><code>label studio ml</code>是label studio的后端配置，其主要提供了一种能够快速将AI模型封装为label studio可使用的预标记服务(提供模型预测服务)</p>
<p><a data-lightbox="71d5ac39-46d6-4fae-a6e1-d3ebfb976271" data-title="label-studio后端配置" href="https://pic.hycbook.com/i/hexo/bk_resources/deep_learning/数据标注工具/label-studio后端配置.webp" target="_blank"><img alt="label-studio后端配置" src="https://pic.hycbook.com/i/hexo/bk_resources/deep_learning/数据标注工具/label-studio后端配置.webp"/></a></p>
<blockquote>
<p>安装: 依赖了rq库和redis库，注意有些库的版本不能过高</p>
</blockquote>
<pre><code class="lang-cmd">pip install <span class="hljs-built_in">label</span>-studio-ml
</code></pre>
<h3 id="模型创建">1.2.2 模型创建</h3>
<blockquote>
<p>创建后端模型</p>
</blockquote>
<p>导入相关库</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> label_studio_ml <span class="hljs-keyword">import</span> model
<span class="hljs-keyword">from</span> label_studio_ml.model <span class="hljs-keyword">import</span> LabelStudioMLBase
<span class="hljs-keyword">from</span> label_studio_ml.utils <span class="hljs-keyword">import</span> get_env
<span class="hljs-keyword">from</span> label_studio_tools.core.utils.io <span class="hljs-keyword">import</span> get_local_path

model.LABEL_STUDIO_ML_BACKEND_V2 = <span class="hljs-keyword">True</span>

os.environ[<span class="hljs-string">'HOSTNAME'</span>] = <span class="hljs-string">'http://192.168.123.xx:8080'</span>
os.environ[<span class="hljs-string">'API_KEY'</span>] = <span class="hljs-string">'TOKEN,在项目的settings里面复制'</span>
os.environ[<span class="hljs-string">'LABEL_STUDIO_ML_BACKEND_V2'</span>] = <span class="hljs-string">'True'</span>
</code></pre>
<p>模型类</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModel</span><span class="hljs-params">(LabelStudioMLBase)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, **kwargs)</span>:</span>
        super(MyModel, self).__init__(**kwargs)
        <span class="hljs-comment"># 按 mmdetection 的方式加载模型及权重</span>
        print(kwargs)
        print(<span class="hljs-string">"初始化完成"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">predict</span><span class="hljs-params">(self, tasks, **kwargs)</span>:</span>
        <span class="hljs-comment"># 获取待标记图片</span>
        print(<span class="hljs-string">"开始预测"</span>)
        images = [get_local_path(task[<span class="hljs-string">'data'</span>][<span class="hljs-string">'image'</span>], hostname=HOSTNAME, access_token=API_KEY) <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks]

        results = []
        all_scores = []

        <span class="hljs-comment"># 这里只是示例, 返回结果都一样</span>
        <span class="hljs-keyword">for</span> img_path <span class="hljs-keyword">in</span> images:
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>):
                w, h = Image.open(img_path).size
                pixel_x, pixel_y, pixel_width, pixel_height = convert_to_ls(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">250</span>, w, h)

                result = {
                    <span class="hljs-string">'id'</span>: <span class="hljs-string">'0'</span>,  <span class="hljs-comment"># 必须为 str，否则前端不显示</span>
                    <span class="hljs-string">'from_name'</span>: <span class="hljs-string">'label'</span>,
                    <span class="hljs-string">'to_name'</span>: <span class="hljs-string">'image'</span>,
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'rectanglelabels'</span>,
                    <span class="hljs-string">'value'</span>: {
                        <span class="hljs-string">'rectanglelabels'</span>: [<span class="hljs-string">'tricycle'</span>],
                        <span class="hljs-string">'x'</span>: pixel_x,  <span class="hljs-comment"># xy 为左上角坐标点</span>
                        <span class="hljs-string">'y'</span>: pixel_y,
                        <span class="hljs-string">'width'</span>: pixel_width,  <span class="hljs-comment"># width,height 为宽高</span>
                        <span class="hljs-string">'height'</span>: pixel_height
                    },
                    <span class="hljs-string">'score'</span>: <span class="hljs-number">0.95</span>
                }
                results.append(result)
                all_scores.append(<span class="hljs-number">0.95</span>)

        print(tasks)
        print(kwargs)
        avg_score = sum(all_scores) / max(len(all_scores), <span class="hljs-number">1</span>)
        results = [{
            <span class="hljs-string">'result'</span>: results,
            <span class="hljs-string">'score'</span>: avg_score
        }]
        <span class="hljs-keyword">return</span> results

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fit</span><span class="hljs-params">(self, completions, num_epochs=<span class="hljs-number">5</span>, **kwargs)</span>:</span>
        <span class="hljs-string">""" 模型训练 """</span>
        print(<span class="hljs-string">"开始训练"</span>)
        <span class="hljs-keyword">if</span> self.gen_train_data(project_id):
            <span class="hljs-comment"># 训练模型</span>
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'model_path'</span>: <span class="hljs-string">r'\runs\detect\TriCycle\weights\best.pt'</span>}
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> <span class="hljs-string">"gen_train_data error"</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_train_data</span><span class="hljs-params">(self, project_id)</span>:</span>
        <span class="hljs-string">""" 获取数据训练数据 """</span>
        print(<span class="hljs-string">"获取数据 project_id"</span>, project_id)
        <span class="hljs-keyword">import</span> zipfile
        <span class="hljs-keyword">import</span> glob
        download_url = f<span class="hljs-string">'{HOSTNAME.rstrip("/")}/api/projects/{project_id}/export?export_type=COCO&amp;download_all_tasks=false&amp;download_resources=true'</span>
        response = requests.get(download_url, headers={<span class="hljs-string">'Authorization'</span>: f<span class="hljs-string">'Token {API_KEY}'</span>})
        zip_path = os.path.join(conf[<span class="hljs-string">'workdir'</span>], <span class="hljs-string">"train.zip"</span>)
        train_path = os.path.join(conf[<span class="hljs-string">'workdir'</span>], <span class="hljs-string">"train"</span>)

        <span class="hljs-keyword">with</span> open(zip_path, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> file:
            file.write(response.content)  <span class="hljs-comment"># 通过二进制写文件的方式保存获取的内容</span>
            file.flush()
        f = zipfile.ZipFile(zip_path)  <span class="hljs-comment"># 创建压缩包对象</span>
        f.extractall(train_path)  <span class="hljs-comment"># 压缩包解压缩</span>
        f.close()
        os.remove(zip_path)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(os.path.join(train_path, <span class="hljs-string">"images"</span>, str(project_id))):
            os.makedirs(os.path.join(train_path, <span class="hljs-string">"images"</span>, str(project_id)))
        <span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> glob.glob(os.path.join(train_path, <span class="hljs-string">"images"</span>, <span class="hljs-string">"*.jpg"</span>)):
            basename = os.path.basename(img)
            shutil.move(img, os.path.join(train_path, <span class="hljs-string">"images"</span>, str(project_id), basename))
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span>
</code></pre>
<h3 id="使用步骤">1.2.3 使用步骤</h3>
<blockquote>
<p>启动后端服务: 分为三步，生成服务代码+启动服务+连接服务+训练模型</p>
</blockquote>
<p><strong>第一步</strong>：生成服务代码</p>
<pre><code class="lang-cmd"><span class="hljs-built_in">label</span>-studio-ml init backend/model --script label_studio_backend/yolo_detection.py --force
</code></pre>
<p><code>label-studio-ml init</code> 命令提供了一种根据后端模型自动生成后端服务代码的功能， <code>model</code> 为输出目录， <code>--script</code> 指定后端模型路径， <code>--force</code> 表示覆盖生成。该命令执行成功后会在 <code>backend</code> 目录下生成 <code>model</code> 目录</p>
<p>主要包括了_wsgi.py、docker-compose.yml、Dockerfile、yolo_detection.py等文件</p>
<p><strong>第二步</strong>：启动服务</p>
<p>如果有依赖的文件，需要自己复制到 <code>model</code> 目录下，接着启动后端服务</p>
<pre><code class="lang-cmd"><span class="hljs-built_in">label</span>-studio-ml <span class="hljs-built_in">start</span> backend/model --host <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> -p <span class="hljs-number">8888</span>
# or
python backend/model/_wsgi.py --host <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> -p <span class="hljs-number">8888</span>  # 方便debug
</code></pre>
<p>启动成功的话，控制台会输出如下的日志</p>
<pre><code class="lang-python">=&gt; ROOT =  Q:\pyCharmWS\object_detection\smart_city_management\label_studio_backend\backend\yolo-detector
=&gt; LABEL STUDIO HOSTNAME =  http://<span class="hljs-number">192.168</span><span class="hljs-number">.123</span>.xx:<span class="hljs-number">8080</span>
 * Serving Flask app <span class="hljs-string">"label_studio_ml.api"</span> (lazy loading)
 * Environment: production
   WARNING: This <span class="hljs-keyword">is</span> a development server. Do <span class="hljs-keyword">not</span> use it <span class="hljs-keyword">in</span> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
[<span class="hljs-number">2023</span><span class="hljs-number">-03</span><span class="hljs-number">-29</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">59</span>,<span class="hljs-number">286</span>] [WARNING] [werkzeug::_log::<span class="hljs-number">225</span>]  * Running on all addresses.
   WARNING: This <span class="hljs-keyword">is</span> a development server. Do <span class="hljs-keyword">not</span> use it <span class="hljs-keyword">in</span> a production deployment.
[<span class="hljs-number">2023</span><span class="hljs-number">-03</span><span class="hljs-number">-29</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">59</span>,<span class="hljs-number">286</span>] [INFO] [werkzeug::_log::<span class="hljs-number">225</span>]  * Running on http://<span class="hljs-number">10.10</span><span class="hljs-number">.0</span>.xx:<span class="hljs-number">8888</span>/ (Press CTRL+C to quit)
</code></pre>
<p><strong>PS</strong>: 测试的时候发现，直接执行<code>_wsgi.py</code>文件一样可以启动后端，跟踪<code>label_studio_ml</code>的<code>server.py</code>文件可以看到执行核心代码</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span>
    args, subargs = get_args()

    <span class="hljs-keyword">if</span> args.command == <span class="hljs-string">'init'</span>:
        create_dir(args)
    <span class="hljs-keyword">elif</span> args.command == <span class="hljs-string">'start'</span>:
        start_server(args, subargs)
    <span class="hljs-keyword">elif</span> args.command == <span class="hljs-string">'deploy'</span>:
        <span class="hljs-keyword">if</span> args.provider == <span class="hljs-string">'gcp'</span>:
            deploy_to_gcp(args)
</code></pre>
<p><strong>第三步</strong>：连接服务</p>
<p>在我们创建的前端项目中依次选择 Settings -&gt; Machine Learning -&gt; Add model ，然后输入后端地址 <code>http://10.100.143.xxx:8888/</code>(这里是后端的地址和端口)，点击保存</p>
<p>此时我们从前端项目中打开待标记图片，前端会自动请求后端对其进行标记(调用后端的 <code>predict</code> 方法)，等待片刻后即可看见预标记结果，我们只需要大致核对无误后点击 submit 即可</p>
<p>如果觉得每次打开图片都需要等待片刻才会收到后端预测结果比较费时，可以在 Settings -&gt; Machine Learning 设置中选择打开 <code>Retrieve predictions when loading a task automatically</code> ，此后前端会在我们每次打开项目时自动对所有任务进行自动预测，基本能够做到无等待</p>
<p><strong>第四步</strong>：训练模型</p>
<p>在 Settings -&gt; Machine Learning 中点击后端服务的 Start Training 按钮，即可调用后端模型使用已标记信息进行训练</p>
<p>也可以 Settings -&gt; Machine Learning 中允许模型自动训练，但训练频率过高会影响程序效率</p>
<blockquote>
<p>目标检测任务注意事项</p>
</blockquote>
<p>predict返回的坐标为<code>convert_to_ls</code>转换后的坐标值</p>
<pre><code class="lang-python"><span class="hljs-comment"># convert from LS percent units to pixels </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_from_ls</span><span class="hljs-params">(result)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'original_width'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result <span class="hljs-keyword">or</span> <span class="hljs-string">'original_height'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>

    value = result[<span class="hljs-string">'value'</span>]
    w, h = result[<span class="hljs-string">'original_width'</span>], result[<span class="hljs-string">'original_height'</span>]

    <span class="hljs-keyword">if</span> all([key <span class="hljs-keyword">in</span> value <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> [<span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>, <span class="hljs-string">'width'</span>, <span class="hljs-string">'height'</span>]]):
        <span class="hljs-keyword">return</span> w * value[<span class="hljs-string">'x'</span>] / <span class="hljs-number">100.0</span>, \
               h * value[<span class="hljs-string">'y'</span>] / <span class="hljs-number">100.0</span>, \
               w * value[<span class="hljs-string">'width'</span>] / <span class="hljs-number">100.0</span>, \
               h * value[<span class="hljs-string">'height'</span>] / <span class="hljs-number">100.0</span>

<span class="hljs-comment"># convert from pixels to LS percent units </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_to_ls</span><span class="hljs-params">(x, y, width, height, original_width, original_height)</span>:</span>
    <span class="hljs-keyword">return</span> x / original_width * <span class="hljs-number">100.0</span>, y / original_height * <span class="hljs-number">100.0</span>, \
           width / original_width * <span class="hljs-number">100.0</span>, height / original_height * <span class="hljs-number">100</span>


<span class="hljs-comment"># convert from LS</span>
output = convert_from_ls(task[<span class="hljs-string">'annotations'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'result'</span>][<span class="hljs-number">0</span>])
<span class="hljs-keyword">if</span> output <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">'Wrong convert'</span>) 
pixel_x, pixel_y, pixel_width, pixel_height = output
print(pixel_x, pixel_y, pixel_width, pixel_height)

<span class="hljs-comment"># convert back to LS </span>
x, y, width, height = convert_to_ls(pixel_x, pixel_y, pixel_width, pixel_height, <span class="hljs-number">600</span>, <span class="hljs-number">403</span>)
print(x, y, width, height)
</code></pre>
<h3 id="例子">1.2.4 例子</h3>
<blockquote>
<p><a href="https://www.swvq.com/boutique/detail/tangijaik" target="_blank">Labelstudio的UIE半监督智能标注方案本地版，赶快用起来啦</a></p>
</blockquote>
<p>基于ner的模型实现</p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env Python</span>
<span class="hljs-comment"># -- coding: utf-8 --</span>

<span class="hljs-string">"""
@version: v1.0
@author: huangyc
@file: uie_model.py
@Description:
            label-studio-ml init backend/model --script uie_model.py --force
@time: 2023/12/14 17:04
"""</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List, Dict

<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> basic_support.logger.logger_config <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> label_studio_ml <span class="hljs-keyword">import</span> model
<span class="hljs-keyword">from</span> label_studio_ml.model <span class="hljs-keyword">import</span> LabelStudioMLBase
<span class="hljs-keyword">from</span> label_studio_ml.utils <span class="hljs-keyword">import</span> get_env

model.LABEL_STUDIO_ML_BACKEND_V2 = <span class="hljs-keyword">True</span>

os.environ[<span class="hljs-string">'HOSTNAME'</span>] = <span class="hljs-string">'http://192.168.xx.xx:8080'</span>
os.environ[<span class="hljs-string">'API_KEY'</span>] = <span class="hljs-string">'d818922361ade7e2d570346d2bd6fe1668fd4e81'</span>
os.environ[<span class="hljs-string">'LABEL_STUDIO_ML_BACKEND_V2'</span>] = <span class="hljs-string">'True'</span>

HOSTNAME = get_env(<span class="hljs-string">'HOSTNAME'</span>)
API_KEY = get_env(<span class="hljs-string">'API_KEY'</span>)
ROOT = os.path.join(os.path.dirname(__file__))

model_url = <span class="hljs-string">'http://region-46.seetacloud.com:12851/xxx'</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">anno</span><span class="hljs-params">(sentences: List[str])</span> -&gt; List[Dict]:</span>
    <span class="hljs-string">"""
    content = ["2018年10月12日，当事人办理个体工商户营业执照，经营场所位于金湖县园林南路5号自北向南第10间，经营范围为食品经营，新鲜水果零售等。"]
    resps = [{'日期时间': [{'text': '2018年10月12日', 'start': 0, 'end': 11, 'probability': 0.9213111485894672}],
          '地名': [{'text': '金湖县', 'start': 33, 'end': 36, 'probability': 0.9889604263625813},
                   {'text': '园林南路', 'start': 36, 'end': 40, 'probability': 0.8983399204114662}]}]

    :param sentences:
    :return:
    """</span>
    x = requests.post(model_url, json=sentences)
    <span class="hljs-keyword">if</span> x.status_code == <span class="hljs-number">200</span>:
        resps = x.json()[<span class="hljs-string">'response'</span>]
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"访问异常"</span>)

    predicts = []
    <span class="hljs-keyword">for</span> resp <span class="hljs-keyword">in</span> resps:
        result = []
        scores = []
        <span class="hljs-keyword">for</span> label, v <span class="hljs-keyword">in</span> resp.items():
            <span class="hljs-keyword">for</span> iv <span class="hljs-keyword">in</span> v:
                score = iv[<span class="hljs-string">'probability'</span>]
                scores.append(score)
                res = {
                    <span class="hljs-string">'from_name'</span>: <span class="hljs-string">'label'</span>,
                    <span class="hljs-string">'to_name'</span>: <span class="hljs-string">'text'</span>,
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'labels'</span>,
                    <span class="hljs-string">'value'</span>: {
                        <span class="hljs-string">'start'</span>: iv[<span class="hljs-string">'start'</span>],
                        <span class="hljs-string">'end'</span>: iv[<span class="hljs-string">'end'</span>],
                        <span class="hljs-string">'score'</span>: score,
                        <span class="hljs-string">'text'</span>: iv[<span class="hljs-string">'text'</span>],
                        <span class="hljs-string">'labels'</span>: [label]
                    }
                }
                result.append(res)

        avg_score = round(sum(scores) / len(scores), <span class="hljs-number">4</span>) <span class="hljs-keyword">if</span> scores <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>
        predicts.append({<span class="hljs-string">"result"</span>: result, <span class="hljs-string">'score'</span>: avg_score, <span class="hljs-string">'model_version'</span>: <span class="hljs-string">'uie-ner-large'</span>})

    <span class="hljs-keyword">return</span> predicts


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UieModel</span><span class="hljs-params">(LabelStudioMLBase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, **kwargs)</span>:</span>
        super(UieModel, self).__init__(**kwargs)
        <span class="hljs-comment"># 按 mmdetection 的方式加载模型及权重</span>
        print(kwargs)
        logger.info(f<span class="hljs-string">"初始化完成"</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">predict</span><span class="hljs-params">(self, tasks, **kwargs)</span>:</span>
        <span class="hljs-comment"># 获取待标记图片</span>
        sentences = []
        <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> tasks:
            sentence = data[<span class="hljs-string">'data'</span>][<span class="hljs-string">'text'</span>]
            sentences.append(sentence)

        <span class="hljs-keyword">return</span> anno(sentences=sentences)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fit</span><span class="hljs-params">(self, completions: List[Dict], workdir=None, **kwargs)</span>:</span>
        <span class="hljs-string">"""
        模型训练
        :param completions: 标注的样本
        :param workdir:
        :param kwargs:
        :return:
        """</span>
        logger.info(f<span class="hljs-string">"开始构建训练样本"</span>)
        sample_path = self.gen_train_data_path(completions=completions)

        <span class="hljs-keyword">return</span> {<span class="hljs-string">'path'</span>: workdir, <span class="hljs-string">'model_path'</span>: <span class="hljs-keyword">None</span>, <span class="hljs-string">'sample_path'</span>: sample_path}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_train_data_path</span><span class="hljs-params">(self, completions: List[Dict])</span>:</span>
        <span class="hljs-string">"""
        获取数据训练数据
        :param completions:
        :return:
        """</span>
        samples = []

        <span class="hljs-keyword">for</span> completion <span class="hljs-keyword">in</span> completions:
            sentence = completion[<span class="hljs-string">'data'</span>][<span class="hljs-string">'text'</span>]
            m_id = completion[<span class="hljs-string">'id'</span>]
            created_at = completion[<span class="hljs-string">"created_at"</span>]
            updated_at = completion[<span class="hljs-string">"updated_at"</span>]

            labels = []
            <span class="hljs-keyword">for</span> annotation <span class="hljs-keyword">in</span> completion[<span class="hljs-string">'annotations'</span>]:
                <span class="hljs-keyword">for</span> label_info <span class="hljs-keyword">in</span> annotation[<span class="hljs-string">'result'</span>]:
                    labels.append(label_info[<span class="hljs-string">'value'</span>])

            sample = {<span class="hljs-string">"text"</span>: sentence, <span class="hljs-string">"id"</span>: m_id, <span class="hljs-string">"label"</span>: labels, <span class="hljs-string">"created_at"</span>: created_at, <span class="hljs-string">"updated_at"</span>: updated_at}
            samples.append(sample)
        logger.info(f<span class="hljs-string">"构建训练样本完毕，开始输出到文件"</span>)

        sample_path = <span class="hljs-string">"./doccano_ext.jsonl"</span>
        <span class="hljs-keyword">with</span> open(sample_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> outfile:
            outfile.write(json.dumps(samples, ensure_ascii=<span class="hljs-keyword">False</span>))

        logger.info(f<span class="hljs-string">"样本路径为：{sample_path}"</span>)

        <span class="hljs-keyword">return</span> sample_path
</code></pre>
<h1 id="doccano">2 doccano</h1>
<blockquote>
<p><a href="https://doccano.herokuapp.com/" target="_blank">doccano官网</a></p>
</blockquote>
<h1 id="roboflow">3 Roboflow</h1>
<blockquote>
<p><a href="https://blog.csdn.net/weixin_43229348/article/details/123502639" target="_blank">如何使用 Roboflow 标注关键点</a></p>
</blockquote>
<p></p><footer class="page-footer"><span class="copyright">Copyright © narutohyc.com 2021 all right reserved，powered by Gitbook</span><span class="footer-modification">该文件修订时间：
2024-02-18 00:48:44
</span></footer><hr/><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el: "#vcomments",appId: 'evyLlP61gQN3G3OM2GQq1rzH-gzGzoHsz',appKey: 'utUrzoiqNaDEGlgr09JL1pXB',placeholder: '欢迎留下评论交流~',avatar: 'wavatar',meta: undefined,pageSize: 15,lang: 'zh-CN',recordIP: false})</script><p></p>
</section>
</div>
<div class="search-results">
<div class="has-results">
<h1 class="search-results-title"><span class="search-results-count"></span> results matching "<span class="search-query"></span>"</h1>
<ul class="search-results-list"></ul>
</div>
<div class="no-results">
<h1 class="search-results-title">No results matching "<span class="search-query"></span>"</h1>
</div>
</div>
</div>
</div>
</div>
</div>
<a aria-label="Previous page: 图神经网络.md" class="navigation navigation-prev" href="图神经网络.html">
<i class="fa fa-angle-left"></i>
</a>
<a aria-label="Next page: 深度学习核心之优化器.md" class="navigation navigation-next" href="深度学习核心之优化器.html">
<i class="fa fa-angle-right"></i>
</a>
<script src="https://cdn.jsdelivr.net/gh/zztongtong/CDN/js/live2d.min.js"></script><div style="position:absolute; bottom:0; left:0; width:200;"><canvas height="350" id="model_1" width="200"></canvas></div></div>
<script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"abbrlink":42221,"date":"2023/04/16 16:44:2","cover":"https://pic.hycbook.com/i/hexo/post_cover/蕾姆3.webp","title":"数据标注工具.md","tags":["数据标注","label-studio","Roboflow"],"top_img":"https://pic.hycbook.com/i/hexo/post_imgs/蕾姆3.webp","mathjax":true,"categories":["deep-learning"],"description":null,"level":"1.13","depth":1,"next":{"title":"深度学习核心之优化器.md","level":"1.14","depth":1,"path":"chapters/深度学习核心之优化器.md","ref":"chapters/深度学习核心之优化器.md","articles":[]},"previous":{"title":"图神经网络.md","level":"1.12","depth":1,"path":"chapters/图神经网络.md","ref":"chapters/图神经网络.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","splitter","expandable-chapters-small","anchors","github","github-buttons","donate","sharing-plus","anchor-navigation-ex","mathjax","mermaid-gb3","tbfed-pagefooter","code","search-plus","-lunr","-search","lightbox","theme-comscore","valine","pageview-count","favicon-absolute","copyright-v"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright © narutohyc.com 2021","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"github":{"url":"https://github.com/hycBook"},"splitter":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"code":{"copyButtons":true},"donate":{"alipay":"https://s2.loli.net/2022/03/23/dEYjkaSGXwe7rnu.png","alipayText":"alipay打赏","button":"欢迎打赏","title":"","wechat":"https://s2.loli.net/2022/03/23/WDiTVSamQBJdEA4.png","wechatText":"wechat打赏"},"favicon-absolute":{"appleTouchIconMore":{},"appleTouchIconPrecomposed152":"./chapters/res/other/favicon.ico","appleTouchIconPrecomposedMore":{},"favicon":"./chapters/res/other/favicon.ico"},"copyright-v":{"copyProtect":false,"enableFooter":false,"site":"https://dl.hycbook.com","author":"narutohyc","website":"深度学习知识驿站","image":"https://s2.loli.net/2022/03/24/pbMd1BCgUNzi7mG.png"},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"mermaid-gb3":{},"anchor-navigation-ex":{"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showGoTop":true,"showLevel":false},"lightbox":{"jquery":true,"sameUuid":false},"theme-comscore":{},"pageview-count":{},"github-buttons":{"buttons":[{"user":"hycBook","repo":"bk_dl_page","type":"star","size":"small","count":true}]},"mathjax":{"forceSVG":false,"version":"2.6-latest"},"expandable-chapters-small":{},"sharing":{"qq":true,"all":["google","facebook","weibo","twitter","qq","qzone","linkedin","pocket"],"douban":true,"facebook":true,"weibo":true,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":false,"google":true,"viber":false,"stumbleupon":false,"qzone":true,"linkedin":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true},"anchors":{},"valine":{"avatar":"wavatar","lang":"zh-CN","pageSize":15,"placeholder":"欢迎留下评论交流~","recordIP":false,"appId":"evyLlP61gQN3G3OM2GQq1rzH-gzGzoHsz","appKey":"utUrzoiqNaDEGlgr09JL1pXB"},"search-plus":{}},"theme":"default","author":"narutohyc","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"深度学习相关学习记录","language":"zh-hans","mathjax":{"forceSVG":true},"links":{"sidebar":{"书籍主页":"https://study.hycbook.com"}},"gitbook":"*","description":"记录 深度学习 的学习和一些技巧的使用"},"file":{"path":"chapters/数据标注工具.md","mtime":"2024-02-18T00:48:44.996Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-02-18T00:49:56.244Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
<canvas class="fireworks"></canvas><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script></div>
<script src="../gitbook/gitbook.js"></script>
<script src="../gitbook/theme.js"></script>
<script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
<script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
<script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-donate/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
<script src="https://cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
<script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
<script src="../gitbook/gitbook-plugin-lightbox/js/lightbox.min.js"></script>
<script src="../gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-copyright-v/plugin.js"></script>
<script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
<script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>
</body>
</html>
